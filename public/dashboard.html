<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Dashboard • Dynamic QR Code</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/header.css">
</head>
<script>
  function toggleProfileMenu() {
    const dd = document.getElementById('profileDropdown');
    dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
  }

  function toggleQRCodeMenu() {
    const dd = document.getElementById('QRCodeDropdown');
    dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
  }

  document.addEventListener('click', (e) => {
    const profileMenu = document.getElementById('profileDropdown');
    const qrMenu = document.getElementById('QRCodeDropdown');
    const profileBtn = document.querySelector('.profile-menu button');
    const qrBtn = document.querySelector('.QRCode-menu button');

    if (!profileMenu.contains(e.target) && !profileBtn.contains(e.target)) {
      profileMenu.style.display = 'none';
    }
    if (!qrMenu.contains(e.target) && !qrBtn.contains(e.target)) {
      qrMenu.style.display = 'none';
    }
  });
</script>
<body>
  <header class="header">
    <a class="header__brand" href="/">Dynamic QR Code</a>
    <nav class="nav">
      <a href="/dashboard.html">Dashboard</a>
      <div class="QRCode-menu">
        <button type="button" onclick="toggleQRCodeMenu()">QR Code ▾</button>
        <div class="QRCode-dropdown" id="QRCodeDropdown">
          <a href="/generateQR.html">Generate QR Codes</a>
          <a href="/qr.html">My QR Codes</a>
        </div>
      </div>
      <div class="profile-menu">
        <button type="button" onclick="toggleProfileMenu()">Profile ▾</button>
        <div class="profile-dropdown" id="profileDropdown">
          <a href="./profile.html">View Profile</a>
          <form action="/auth/logout" method="post">
            <button type="submit">Logout</button>
          </form>
        </div>
      </div>
    </nav>
  </header>

  <main class="dashboard-wrap">
    <div class="toolbar">
      <div id="greeting" style="font-weight:600;"></div>
    </div>

    <div class="chart-container">
      <div class="chart-row">
        <iframe id="chart-today" width="100%" height="300" frameborder="0"></iframe>
        <iframe id="chart-today-per-qr" width="100%" height="300" frameborder="0"></iframe>
      </div>
    </div>

    <div class="chart-container">
      <iframe id="chart-30d" width="100%" height="400" frameborder="0"></iframe>
    </div>

    <div class="date-filter-section">
      <div class="section-header">
        <h3 class="section-title">Date Filter (Previous 30 days)</h3>
      </div>
      <div class="date-input-container">
        <input list="dates" id="scanDate" class="date-input" placeholder="Choose date for analysis">
        <datalist id="dates"></datalist>
      </div>
    </div>

  <div class="chart-container">
    <iframe id="chart-custom" width="100%" height="400" frameborder="0"></iframe>
  </div>
    

    <!-- <div class="dashboard-grid">
      <div class="kpi">
        <h2>Total scans (today)</h2>
        <div class="num" id="kpi-today">—</div>
      </div>
      <div class="kpi">
        <h2>Total scans (30d)</h2>
        <div class="num" id="kpi-30d">—</div>
      </div>
    </div> -->

  </main>

  <script>
    (async function() {
      // get current logged-in user
      const r = await fetch('/api/me', { credentials: 'include' });
      if (r.status === 401) {
        location.href = '/login.html?error=Session+expired';
        return;
      }
      const me = await r.json();

      // inject userId into Grafana iframe URLs
      const todayIframe = document.getElementById('chart-today');
      todayIframe.src = `http://analytics.sg-akc.com/d-solo/bc26ffb9-588c-4033-a77b-5a10af9df52d/dynamic-qr-code?orgId=1&from=now-1d&to=now&timezone=browser&panelId=1&var-userId=${me.id}`;

      const todayPerQrIframe = document.getElementById('chart-today-per-qr');
      todayPerQrIframe.src = `http://analytics.sg-akc.com/d-solo/bc26ffb9-588c-4033-a77b-5a10af9df52d/dynamic-qr-code?orgId=1&from=now-1d&to=now&timezone=browser&panelId=3&var-userId=${me.id}`;

      const monthIframe = document.getElementById('chart-30d');
      monthIframe.src = `http://analytics.sg-akc.com/d-solo/bc26ffb9-588c-4033-a77b-5a10af9df52d/dynamic-qr-code?orgId=1&from=now-30d&to=now&timezone=browser&panelId=2&var-userId=${me.id}`;

      // Filterable chart
      const input = document.getElementById('scanDate');
      const datalist = document.getElementById('dates');
      const chart = document.getElementById('chart-custom');

      // generate last 30 days
      const today = new Date();
      for (let i=0; i<30; i++){
        const d = new Date(today); d.setDate(today.getDate()-i);
        const formatted = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        const opt = document.createElement('option'); opt.value = formatted; datalist.appendChild(opt);
      }
      
      // default = first day of month
      const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
      const firstDayFormatted = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,"0")}-01`;
      input.value = firstDayFormatted;

      function updateChart(date) {
      // Convert the selected date to start and end of day timestamps
      const selectedDate = new Date(date);
      const startOfDay = new Date(selectedDate);
      startOfDay.setHours(0, 0, 0, 0);
      const endOfDay = new Date(selectedDate);
      endOfDay.setHours(23, 59, 59, 999);
      
      // Convert to milliseconds (Grafana timestamp format)
      const fromTimestamp = startOfDay.getTime();
      const toTimestamp = endOfDay.getTime();
    
      // Update the chart URL with dynamic values
      chart.src = `http://analytics.sg-akc.com/d-solo/bc26ffb9-588c-4033-a77b-5a10af9df52d/dynamic-qr-code?orgId=1&from=${fromTimestamp}&to=${toTimestamp}&timezone=browser&var-userId=${me.id}&var-scanDate=${date}&panelId=4&__feature.dashboardSceneSolo=true`;
    }

    updateChart(firstDayFormatted);
    input.addEventListener('change', ()=> updateChart(input.value));
      // greeting
      document.getElementById('greeting').textContent = `Hello, ${me.email}`;
    })();
  
    function toggleProfileMenu() {
      const dd = document.getElementById('profileDropdown');
      dd.style.display = dd.style.display === 'block' ? 'none' : 'block';
    }
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('profileDropdown');
      const btn = document.querySelector('.profile-menu button');
      if (!menu.contains(e.target) && !btn.contains(e.target)) {
        menu.style.display = 'none';
      }
    });

    (async function(){
      const r = await fetch('/api/me', { credentials: 'include' });
      if (r.status === 401) { location.href = '/login.html?error=Session+expired'; return; }
      const me = await r.json();
      document.getElementById('greeting').textContent = `Hello, ${me.email}`;
    })();
  </script>
</body>
</html>
