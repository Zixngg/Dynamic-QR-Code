<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit QR • Dynamic QR Code</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Shared styles -->
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/header.css">
  <!-- Page-specific styles -->
  <link rel="stylesheet" href="css/generate.css">
</head>
<body>
<header class="header">
  <a class="header__brand" href="/dashboard.html">Dynamic QR Code</a>
  <nav class="nav">
    <a href="/dashboard.html">Dashboard</a>
    <div class="QRCode-menu">
      <button type="button" onclick="toggleQRCodeMenu()">QR Code ▾</button>
      <div class="QRCode-dropdown" id="QRCodeDropdown">
        <a href="/generateQR.html">Generate QR Codes</a>
        <a href="/qr.html">My QR Codes</a>
      </div>
    </div>
    <div class="profile-menu">
      <button type="button" onclick="toggleProfileMenu()">Profile ▾</button>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="./profile.html">View Profile</a>
        <form action="/auth/logout" method="post"><button type="submit">Logout</button></form>
      </div>
    </div>
  </nav>
</header>

<main class="container">
  <div class="grid wide">
    <!-- QR Code Info Section -->
    <div class="card">
      <div class="form-header">
        <h1>🖊️ Edit QR Code</h1>
        <p class="sub">Update your QR code destination and design settings.</p>
      </div>

      <div id="form-msg"></div>

      <div class="form-section">
        <div class="section-header">
          <h3>📱 QR Code Info</h3>
          <span class="section-badge">Current</span>
        </div>
        
        <div class="qr-line" style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px; padding: 16px; border: 1px solid var(--border); border-radius: 8px; background: #fafbfc;">
          <img id="qrImg" alt="QR" style="width: 120px; height: 120px; border: 1px solid var(--border); border-radius: 8px;">
          <div style="flex: 1;">
            <div class="info-item" style="margin-bottom: 8px;">
              <strong>Name:</strong> 
              <span id="qrName" class="editable-field" data-field="name">—</span>
              <button class="edit-btn" onclick="editField('name')" title="Edit name">✏️</button>
            </div>
            <div class="info-item" style="margin-bottom: 8px;">
              <strong>Slug:</strong> 
              <span id="qrSlug" class="editable-field" data-field="slug">—</span>
              <button class="edit-btn" onclick="editField('slug')" title="Edit slug">✏️</button>
            </div>
            <div class="info-item" style="margin-bottom: 8px;">
              <strong>Tags:</strong> 
              <div id="qrTags" class="editable-field" data-field="tags" style="display: inline-block;">
                <span class="no-tags">No tags</span>
              </div>
              <button class="edit-btn" onclick="editField('tags')" title="Edit tags">✏️</button>
            </div>
            <div style="margin-bottom: 8px;"><a id="qrDyn" class="link" href="#" target="_blank">Open dynamic link</a></div>
            <div style="margin-bottom: 12px;">
              <a id="dlLink" class="link" href="#" download>Download QR Code (SVG)</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Target Form -->
    <form class="card" id="targetForm">
      <div class="form-header">
        <h2>🎯 Update Destination</h2>
        <p class="sub">Change where your QR code redirects users.</p>
      </div>

      <div id="target-msg"></div>

      <div class="form-section">
        <div class="section-header">
          <h3>📍 New Destination</h3>
          <span class="section-badge">Required</span>
        </div>
        
        <div class="row">
          <label class="input-label">
            <span class="label-text">Destination URL</span>
            <span class="label-required">*</span>
          </label>
          <input class="input" type="url" name="url" id="url" placeholder="https://example.com/new-landing-page" required>
          <div class="help">The new webpage users will see after scanning your QR code.</div>
        </div>

        <div class="row row-inline">
          <div class="input-group">
            <label class="input-label">utm_source</label>
            <input class="input" type="text" name="utm_source" id="utm_source" placeholder="e.g., flyer, poster, business-card">
            <div class="help">Where did users find this QR code?</div>
          </div>
          <div class="input-group">
            <label class="input-label">utm_medium</label>
            <input class="input" type="text" name="utm_medium" id="utm_medium" placeholder="e.g., qr, print, digital">
            <div class="help">What type of medium?</div>
          </div>
          <div class="input-group">
            <label class="input-label">utm_campaign</label>
            <input class="input" type="text" name="utm_campaign" id="utm_campaign" placeholder="e.g., summer2024, launch-event">
            <div class="help">What campaign is this for?</div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" type="submit">
          <span class="btn-icon">🎯</span>
          Update Target
        </button>
        <div class="form-note">
          <span class="note-icon">💡</span>
          This changes where users go when they scan your QR code. The QR image stays the same.
        </div>
      </div>
    </form>

    <!-- Design and Preview Section -->
    <div class="design-preview-container">
      <!-- Update Design Form -->
      <form class="card" id="designForm">
        <div class="form-header">
          <h2>🎨 Update Design</h2>
          <p class="sub">Customize the appearance of your QR code.</p>
        </div>

        <div id="design-msg"></div>

        <div class="form-section">
          <div class="section-header">
            <h3>🎨 Visual Design</h3>
            <span class="section-badge">Customize</span>
          </div>
          
          <div class="design-grid">
            <div class="design-group">
              <label class="input-label">Colors</label>
              <div class="color-inputs">
                <div class="color-input">
                  <label class="color-label">Foreground</label>
                  <input class="input color-picker" type="color" name="fg" id="fg" value="#0b3d91">
                  <span class="color-value">#0b3d91</span>
                </div>
                <div class="color-input">
                  <label class="color-label">Background</label>
                  <input class="input color-picker" type="color" name="bg" id="bg" value="#ffffff">
                  <span class="color-value">#ffffff</span>
                </div>
              </div>
            </div>

            <div class="design-group">
              <label class="input-label">Error Correction</label>
              <select class="input" name="ec" id="ec">
                <option value="L">L (7%) - Low</option>
                <option value="M" selected>M (15%) - Medium</option>
                <option value="Q">Q (25%) - High</option>
                <option value="H">H (30%) - Highest</option>
              </select>
              <div class="help">Higher levels allow more damage before the QR becomes unreadable.</div>
            </div>

          </div>

          <div class="row">
            <label class="input-label">
              <span class="label-text">Center Logo</span>
              <span class="label-optional">Optional</span>
            </label>
            <div class="logo-upload-area">
              <div class="logo-upload-box" id="logoUploadBox">
                <div class="upload-icon">📁</div>
                <div class="upload-text">
                  <span class="upload-title">Click to upload logo</span>
                  <span class="upload-subtitle">PNG, JPG, SVG up to 5MB</span>
                </div>
                <input type="file" id="logoInput" accept=".png,.jpg,.jpeg,.svg" style="display: none;" />
              </div>
              <div class="logo-preview" id="logoPreview" style="display: none;">
                <img id="logoThumb" alt="logo preview">
                <div class="logo-controls">
                  <button type="button" class="btn-remove-logo" id="removeLogo">✕</button>
                  <div class="logo-size-control">
                    <label>Size: </label>
                    <input class="input" type="number" name="logoSizePct" id="logoSizePct" min="10" max="40" value="22">
                    <span>%</span>
                  </div>
                </div>
              </div>
            </div>
            <input type="hidden" name="logoUrl" id="logoUrl">
            <div class="help">Add your logo to the center of the QR code. Recommended size: 15-25% for best readability.</div>
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" type="submit">
            <span class="btn-icon">🎨</span>
            Update Design
          </button>
          <div class="form-note">
            <span class="note-icon">💡</span>
            This changes the visual appearance of your QR code. You'll need to download the new version.
          </div>
        </div>
      </form>

      <!-- Live Preview -->
      <div class="preview-card">
        <div class="form-header">
          <h2>🎯 Live Preview</h2>
          <p class="sub">See your QR code changes in real-time.</p>
        </div>
        
        <div class="preview-box">
          <div class="preview-status">
            <span class="status-indicator" id="previewStatus">Ready</span>
          </div>
          <div class="qr-container">
            <div id="previewSvg" class="qr-svg-container"></div>
            <div class="qr-overlay" id="qrOverlay">
              <div class="scan-hint">📱 Scan to test</div>
            </div>
          </div>
        </div>
        
        <div class="preview-info">
          <div class="info-item">
            <span class="info-label">Short Link:</span>
            <span class="info-value" id="previewShortLink">yourdomain.com/r/abc123</span>
          </div>
          <div class="info-item">
            <span class="info-label">Destination:</span>
            <span class="info-value" id="previewDestination">https://example.com</span>
          </div>
          <div class="info-item">
            <span class="info-label">Format:</span>
            <span class="info-value" id="previewFormat">SVG</span>
          </div>
          <div class="info-item">
            <span class="info-label">Error Correction:</span>
            <span class="info-value" id="previewEC">M (15%)</span>
          </div>
          <div class="info-item">
            <span class="info-label">Colors:</span>
            <span class="info-value" id="previewColors">#0b3d91 on #ffffff</span>
          </div>
        </div>
        
        <div class="preview-actions">
          <div class="help">Preview updates automatically as you make changes.</div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
  // dropdowns
  function toggleProfileMenu(){ const dd=document.getElementById('profileDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  function toggleQRCodeMenu(){ const dd=document.getElementById('QRCodeDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  document.addEventListener('click', (e) => {
    ['profile','QRCode'].forEach(k=>{
      const menu=document.getElementById(k+'Dropdown');
      const btn=document.querySelector('.'+k+'-menu button');
      if(menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) menu.style.display='none';
    });
  });

  // messages
  const params = new URLSearchParams(location.search);
  const msgEl = document.getElementById('form-msg');
  const slug = params.get('slug');
  let currentLogoDataUrl = '';
  let qrData = null;
  let originalSlug = null;

  if (!slug) {
    msgEl.className='error'; 
    msgEl.textContent='Missing slug';
  } else {
    // preload details
    (async function(){
      const me = await fetch('/api/me', { credentials:'include' });
      if (me.status===401) { location.href='/login.html?error=Session+expired'; return; }

      const r = await fetch('/qr/'+encodeURIComponent(slug)+'/data', { credentials:'include' });
      if (!r.ok) { msgEl.className='error'; msgEl.textContent='Not found'; return; }
      qrData = await r.json();

      // Populate QR info
      document.getElementById('qrName').textContent = qrData.Name;
      document.getElementById('qrSlug').textContent = qrData.Slug;
      document.getElementById('url').value = qrData.Url || '';
      
      // Populate tags
      console.log('Raw qrData.Tags:', qrData.Tags);
      console.log('Type of qrData.Tags:', typeof qrData.Tags);
      
      let tags = [];
      if (qrData.Tags) {
        if (typeof qrData.Tags === 'string') {
          try {
            tags = JSON.parse(qrData.Tags);
            console.log('Parsed tags from string:', tags);
          } catch (e) {
            console.error('Error parsing tags:', e);
            tags = [];
          }
        } else if (Array.isArray(qrData.Tags)) {
          tags = qrData.Tags;
          console.log('Tags already array:', tags);
        }
      }
      
      console.log('Final tags for display:', tags);
      
      if (tags && tags.length > 0) {
        const tagsContainer = document.getElementById('qrTags');
        tagsContainer.innerHTML = tags.map(tag => 
          `<span class="tag" style="background-color: ${tag.color}; color: white; margin-right: 4px;">${tag.name}</span>`
        ).join('');
      } else {
        document.getElementById('qrTags').innerHTML = '<span class="no-tags">No tags</span>';
      }
      
      // Store original slug for reference
      originalSlug = qrData.Slug;
      
      // Populate UTM data
      if (qrData.UTM) {
        if (qrData.UTM.source && qrData.UTM.source !== null && qrData.UTM.source !== '') {
          document.getElementById('utm_source').value = qrData.UTM.source;
        }
        if (qrData.UTM.medium && qrData.UTM.medium !== null && qrData.UTM.medium !== '') {
          document.getElementById('utm_medium').value = qrData.UTM.medium;
        }
        if (qrData.UTM.campaign && qrData.UTM.campaign !== null && qrData.UTM.campaign !== '') {
          document.getElementById('utm_campaign').value = qrData.UTM.campaign;
        }
      }

      // Populate design data
      if (qrData.Design) {
        if (qrData.Design.fg) document.getElementById('fg').value = qrData.Design.fg;
        if (qrData.Design.bg) document.getElementById('bg').value = qrData.Design.bg;
        if (qrData.Design.ec) document.getElementById('ec').value = qrData.Design.ec;
        if (qrData.Design.logoSizePct) document.getElementById('logoSizePct').value = qrData.Design.logoSizePct;
        if (qrData.Design.logoUrl) {
          document.getElementById('logoUrl').value = qrData.Design.logoUrl;
          currentLogoDataUrl = qrData.Design.logoUrl;
          
          // Show existing logo
          const logoThumb = document.getElementById('logoThumb');
          const logoPreview = document.getElementById('logoPreview');
          const logoUploadBox = document.getElementById('logoUploadBox');
          
          logoThumb.src = qrData.Design.logoUrl;
          logoPreview.style.display = 'block';
          logoUploadBox.style.display = 'none';
        }
      }

      // Set up QR image and links
      const img = document.getElementById('qrImg');
      const dl = document.getElementById('dlLink');
      const dyn = document.getElementById('qrDyn');

      // Get current format from design data or default to svg
      const currentFormat = qrData.Design?.format || 'svg';
      
      img.src = '/qr/'+encodeURIComponent(slug)+'/svg'; // Always show SVG for preview
      dl.href = '#'; // Will be set dynamically when clicked
      dyn.href = '/r/'+encodeURIComponent(slug);

      // Update preview with current values
      refreshPreview();

      // Show success/error messages
      if (params.get('success')) {
        msgEl.className='success';
        msgEl.textContent=params.get('success');
      }
      if (params.get('error')) {
        msgEl.className='error';
        msgEl.textContent=params.get('error');
      }
    })();
  }

  // Color picker updates
  function updateColorValues() {
    const fgInput = document.getElementById('fg');
    const bgInput = document.getElementById('bg');
    const fgValue = fgInput.nextElementSibling;
    const bgValue = bgInput.nextElementSibling;
    
    fgValue.textContent = fgInput.value;
    bgValue.textContent = bgInput.value;
  }

  // Live preview with enhanced info
  function refreshPreview() {
      const fg = document.getElementById('fg').value;
      const bg = document.getElementById('bg').value;
      const ec = document.getElementById('ec').value;
      const logoUrl = document.getElementById('logoUrl').value || '';
      const logoSizePct = document.getElementById('logoSizePct').value || '22';
    const url = document.getElementById('url').value || '';
    const utmSource = document.getElementById('utm_source').value || '';
    const utmMedium = document.getElementById('utm_medium').value || '';
    const utmCampaign = document.getElementById('utm_campaign').value || '';

    // Build the preview URL with actual destination
    let previewUrl = url;
    if (previewUrl) {
      // Add UTM parameters if provided
      const utmParams = new URLSearchParams();
      if (utmSource) utmParams.set('utm_source', utmSource);
      if (utmMedium) utmParams.set('utm_medium', utmMedium);
      if (utmCampaign) utmParams.set('utm_campaign', utmCampaign);
      
      if (utmParams.toString()) {
        previewUrl += (previewUrl.includes('?') ? '&' : '?') + utmParams.toString();
      }
    }

    const qs = new URLSearchParams({ 
      fg, 
      bg, 
      ec, 
      logoUrl, 
      logoSizePct,
      url: previewUrl || 'https://example.com/preview' // Fallback for preview
    });
    
    const previewSvg = document.getElementById('previewSvg');
    const previewStatus = document.getElementById('previewStatus');
    
    // Show loading state
    previewStatus.textContent = 'Loading...';
    previewStatus.className = 'status-indicator';
    
    // Update preview SVG with error handling
    const previewUrl_full = '/qr/preview?' + qs.toString();
    
    fetch(previewUrl_full)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        return response.text();
      })
      .then(svgContent => {
        previewSvg.innerHTML = svgContent;
        previewStatus.textContent = 'Ready';
        previewStatus.className = 'status-indicator';
      })
      .catch(error => {
        previewStatus.textContent = 'Preview Error';
        previewStatus.className = 'status-indicator error';
        console.error('Failed to load QR preview:', error);
      });
    
    // Update preview info
    const shortLinkSlug = slug || 'abc123';
    const shortLink = `yourdomain.com/r/${shortLinkSlug}`;
    const destination = previewUrl || 'https://example.com';
    
      document.getElementById('previewShortLink').textContent = shortLink;
      document.getElementById('previewDestination').textContent = destination.length > 30 ? destination.substring(0, 30) + '...' : destination;
      document.getElementById('previewFormat').textContent = 'SVG';
      document.getElementById('previewEC').textContent = document.getElementById('ec').options[document.getElementById('ec').selectedIndex].textContent;
      document.getElementById('previewColors').textContent = `${fg} on ${bg}`;
    
    // Update color values
    updateColorValues();
  }

  // Enhanced logo upload
  function setupLogoUpload() {
    const logoInput = document.getElementById('logoInput');
    const logoUploadBox = document.getElementById('logoUploadBox');
    const logoPreview = document.getElementById('logoPreview');
    const logoThumb = document.getElementById('logoThumb');
    const removeLogoBtn = document.getElementById('removeLogo');
    
    // Click to upload
    logoUploadBox.addEventListener('click', () => logoInput.click());
    
    // Drag and drop
    logoUploadBox.addEventListener('dragover', (e) => {
      e.preventDefault();
      logoUploadBox.classList.add('drag-over');
    });
    
    logoUploadBox.addEventListener('dragleave', () => {
      logoUploadBox.classList.remove('drag-over');
    });
    
    logoUploadBox.addEventListener('drop', (e) => {
      e.preventDefault();
      logoUploadBox.classList.remove('drag-over');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        logoInput.files = files;
        handleLogoUpload(files[0]);
      }
    });
    
    // File input change
    logoInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (file) handleLogoUpload(file);
    });
    
    // Remove logo
    removeLogoBtn.addEventListener('click', () => {
      document.getElementById('logoUrl').value = '';
      logoPreview.style.display = 'none';
      logoUploadBox.style.display = 'flex';
      logoInput.value = '';
      refreshPreview();
    });
  }

  async function handleLogoUpload(file) {
    if (!file) return;
    
    // Validate file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
      alert('File size must be less than 5MB');
      return;
    }
    
    const fd = new FormData();
    fd.set('file', file);
    
    const previewStatus = document.getElementById('previewStatus');
    previewStatus.textContent = 'Uploading...';
    previewStatus.className = 'status-indicator';
    
    try {
      const res = await fetch('/uploads', { method: 'POST', body: fd, credentials: 'include' });
      if (!res.ok) { 
        alert('Upload failed. Please try again.'); 
        previewStatus.textContent = 'Upload Error';
        previewStatus.className = 'status-indicator error';
        return; 
      }
      
      const data = await res.json();
      document.getElementById('logoUrl').value = data.url || data.dataUrl;
      currentLogoDataUrl = data.url || data.dataUrl;
      
      const logoThumb = document.getElementById('logoThumb');
      const logoPreview = document.getElementById('logoPreview');
      const logoUploadBox = document.getElementById('logoUploadBox');
      
      logoThumb.src = data.url;
      logoPreview.style.display = 'block';
      logoUploadBox.style.display = 'none';
      
      // Force refresh preview after successful upload
      setTimeout(() => {
        refreshPreview();
      }, 100);
      
    } catch (error) {
      console.error('Upload error:', error);
      alert('Upload failed. Please check your connection and try again.');
      previewStatus.textContent = 'Upload Error';
      previewStatus.className = 'status-indicator error';
    }
  }

  // Update target form submission
  document.getElementById('targetForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!slug) return;

    const targetMsgEl = document.getElementById('target-msg');
    targetMsgEl.className = '';
    targetMsgEl.textContent = '';

    const urlParams = new URLSearchParams({
      url: document.getElementById('url').value,
      utm_source: document.getElementById('utm_source').value,
      utm_medium: document.getElementById('utm_medium').value,
      utm_campaign: document.getElementById('utm_campaign').value
    });

    const r = await fetch('/qr/' + encodeURIComponent(slug) + '/retarget', {
      method: 'POST',
      body: urlParams,
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      credentials: 'include'
    });

    if (r.redirected) {
      location.href = r.url;
      return;
    }

    if (r.ok) {
      targetMsgEl.className = 'success';
      targetMsgEl.textContent = 'Target updated successfully';
      refreshPreview();
    } else {
      targetMsgEl.className = 'error';
      targetMsgEl.textContent = 'Failed to update target';
    }
  });

  // Update design form submission
  document.getElementById('designForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!slug) return;
    
    const designMsgEl = document.getElementById('design-msg');
    designMsgEl.className = '';
    designMsgEl.textContent = '';
    
    const hiddenLogo = document.getElementById('logoUrl').value;
    const logoUrlValue = currentLogoDataUrl || hiddenLogo;
    
    const body = new URLSearchParams({
      fg: document.getElementById('fg').value,
      bg: document.getElementById('bg').value,
      ec: document.getElementById('ec').value,
      logoUrl: encodeURIComponent(logoUrlValue),
      logoSizePct: document.getElementById('logoSizePct').value
    });
    
    const r = await fetch('/qr/' + encodeURIComponent(slug) + '/design', {
      method:'POST', 
      body, 
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, 
      credentials:'include'
    });
    
    if (r.redirected) { 
      location.href = r.url; 
      return; 
    }
    
    if (r.ok) { 
      designMsgEl.className='success'; 
      designMsgEl.textContent='Design updated successfully';
      refreshPreview();
    } else { 
      designMsgEl.className='error'; 
      designMsgEl.textContent='Failed to update design'; 
    }
  });

  // Download functionality
  document.getElementById('dlLink').addEventListener('click', (e) => {
    e.preventDefault();
    const link = document.createElement('a');
    link.href = '/qr/' + encodeURIComponent(slug) + '/svg';
    link.download = slug + '.svg';
    link.click();
  });

  // Initialize everything
  document.addEventListener('DOMContentLoaded', () => {
    setupLogoUpload();
    
    // Add event listeners for preview updates
    ['fg','bg','ec','logoSizePct','url','utm_source','utm_medium','utm_campaign'].forEach(name => {
      const element = document.getElementById(name);
      if (element) {
        element.addEventListener('change', refreshPreview);
        element.addEventListener('input', refreshPreview);
      }
    });
    
    // Initial render
    refreshPreview();
  });

  // Edit field function
  function editField(fieldType) {
    const fieldElement = document.getElementById(`qr${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}`);
    
    if (fieldType === 'tags') {
      // Parse existing tags
      let currentTags = [];
      if (qrData.Tags) {
        if (typeof qrData.Tags === 'string') {
          try {
            currentTags = JSON.parse(qrData.Tags);
          } catch (e) {
            console.error('Error parsing tags:', e);
            currentTags = [];
          }
        } else if (Array.isArray(qrData.Tags)) {
          currentTags = qrData.Tags;
        }
      }
      
      const container = document.createElement('div');
      container.className = 'inline-tag-editor';
      container.innerHTML = `
        <div class="tag-input-row">
          <input type="text" id="editTagNameInput" placeholder="Tag name" class="input">
          <input type="color" id="editTagColorInput" value="#4ecdc4" class="color-picker">
          <button type="button" id="editAddTagBtn" class="btn btn-secondary">Add</button>
        </div>
        <div class="tags-display" id="editTagsDisplay"></div>
      `;
      
      const actionsContainer = document.createElement('div');
      actionsContainer.className = 'edit-actions';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.innerHTML = '✓';
      saveBtn.onclick = () => saveField(fieldType, container, saveBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.innerHTML = '✕';
      cancelBtn.onclick = () => cancelFieldEdit(fieldElement, currentTags);
      
      actionsContainer.appendChild(saveBtn);
      actionsContainer.appendChild(cancelBtn);
      
      fieldElement.style.display = 'none';
      fieldElement.parentElement.querySelector('.edit-btn').style.display = 'none';
      
      fieldElement.parentElement.appendChild(container);
      fieldElement.parentElement.appendChild(actionsContainer);
      
      // Initialize tag editing
      editTags = [...currentTags];
      updateEditTagsDisplay();
      
      // Add event listeners
      document.getElementById('editAddTagBtn').addEventListener('click', addEditTag);
      document.getElementById('editTagNameInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          addEditTag();
        }
      });
      
      document.getElementById('editTagNameInput').focus();
    } else {
      const originalValue = fieldElement.textContent;
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = originalValue;
      input.className = 'edit-input';
      input.maxLength = fieldType === 'name' ? 100 : 50;
      
      if (fieldType === 'slug') {
        input.pattern = '[a-zA-Z0-9-_]+';
        input.title = 'Only letters, numbers, hyphens, and underscores allowed';
      }
      
      const actionsContainer = document.createElement('div');
      actionsContainer.className = 'edit-actions';
      
      const saveBtn = document.createElement('button');
      saveBtn.className = 'save-btn';
      saveBtn.innerHTML = '✓';
      saveBtn.onclick = () => saveField(fieldType, input, saveBtn);
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'cancel-btn';
      cancelBtn.innerHTML = '✕';
      cancelBtn.onclick = () => cancelFieldEdit(fieldElement, originalValue);
      
      actionsContainer.appendChild(saveBtn);
      actionsContainer.appendChild(cancelBtn);
      
      fieldElement.style.display = 'none';
      fieldElement.parentElement.querySelector('.edit-btn').style.display = 'none';
      
      fieldElement.parentElement.appendChild(input);
      fieldElement.parentElement.appendChild(actionsContainer);
      
      input.focus();
      input.select();
    }
  }

  // Tag editing variables
  let editTags = [];
  
  function addEditTag() {
    const nameInput = document.getElementById('editTagNameInput');
    const colorInput = document.getElementById('editTagColorInput');
    const name = nameInput.value.trim();
    
    if (!name) return;
    
    // Check if tag already exists
    if (editTags.some(tag => tag.name.toLowerCase() === name.toLowerCase())) {
      alert('Tag already exists');
      return;
    }
    
    editTags.push({
      name: name,
      color: colorInput.value
    });
    
    updateEditTagsDisplay();
    
    nameInput.value = '';
    colorInput.value = '#4ecdc4';
  }
  
  function removeEditTag(index) {
    editTags.splice(index, 1);
    updateEditTagsDisplay();
  }
  
  function updateEditTagsDisplay() {
    const display = document.getElementById('editTagsDisplay');
    display.innerHTML = editTags.map((tag, index) => `
      <span class="tag" style="background-color: ${tag.color}; color: white;">
        ${tag.name}
        <button type="button" onclick="removeEditTag(${index})" class="tag-remove">×</button>
      </span>
    `).join('');
  }

  // Save field function
  async function saveField(fieldType, input, saveBtn) {
    if (fieldType === 'tags') {
      // Handle tag saving
      const fieldElement = document.getElementById(`qr${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}`);
      
      try {
        console.log('Sending tags update:', editTags);
        const response = await fetch(`/api/qr/${encodeURIComponent(originalSlug)}/update`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ tags: editTags })
        });

        if (response.ok) {
          // Update the display
          if (editTags.length > 0) {
            fieldElement.innerHTML = editTags.map(tag => 
              `<span class="tag" style="background-color: ${tag.color}; color: white; margin-right: 4px;">${tag.name}</span>`
            ).join('');
          } else {
            fieldElement.innerHTML = '<span class="no-tags">No tags</span>';
          }
          
          // Update qrData
          qrData.Tags = editTags;
          
          // Show success message
          msgEl.className = 'success';
          msgEl.textContent = 'Tags updated successfully';
          
          // Clean up
          const container = fieldElement.parentElement.querySelector('.inline-tag-editor');
          const actionsContainer = fieldElement.parentElement.querySelector('.edit-actions');
          
          if (container) container.remove();
          if (actionsContainer) actionsContainer.remove();
          
          fieldElement.style.display = 'inline-block';
          fieldElement.parentElement.querySelector('.edit-btn').style.display = 'inline-block';
        } else {
          const errorText = await response.text();
          msgEl.className = 'error';
          msgEl.textContent = `Failed to update tags: ${errorText}`;
        }
      } catch (error) {
        console.error('Error updating tags:', error);
        msgEl.className = 'error';
        msgEl.textContent = `Error updating tags: ${error.message}`;
      }
      return;
    }
    
    const newValue = input.value.trim();
    const fieldElement = document.getElementById(`qr${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)}`);
    
    if (!newValue) {
      alert(`${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)} cannot be empty`);
      return;
    }
    
    if (fieldType === 'slug' && !/^[a-zA-Z0-9-_]+$/.test(newValue)) {
      alert('Slug can only contain letters, numbers, hyphens, and underscores');
      return;
    }
    
    if (newValue === fieldElement.textContent) {
      cancelFieldEdit(fieldElement, newValue);
      return;
    }
    
    saveBtn.disabled = true;
    saveBtn.innerHTML = '...';
    
    try {
      const updateData = { [fieldType]: newValue };
      const response = await fetch(`/api/qr/${encodeURIComponent(originalSlug)}/update`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(updateData)
      });
      
      if (!response.ok) {
        const error = await response.text();
        throw new Error(error || `Failed to update ${fieldType}`);
      }
      
      // Update the field
      fieldElement.textContent = newValue;
      
      // Show success message
      msgEl.className = 'success';
      msgEl.textContent = `${fieldType.charAt(0).toUpperCase() + fieldType.slice(1)} updated successfully`;
      
      // If slug changed, update the page URL and all references
      if (fieldType === 'slug') {
        originalSlug = newValue;
        // Update the page URL without reload
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('slug', newValue);
        window.history.replaceState({}, '', newUrl);
        
        // Update all links and references
        document.getElementById('qrDyn').href = `/r/${encodeURIComponent(newValue)}`;
        document.getElementById('dlLink').href = `/qr/${encodeURIComponent(newValue)}/svg`;
        document.querySelector('img#qrImg').src = `/qr/${encodeURIComponent(newValue)}/svg`;
        
        // Update qrData
        qrData.Slug = newValue;
      } else {
        // Update qrData
        qrData.Name = newValue;
      }
      
      cancelFieldEdit(fieldElement, newValue);
    } catch (error) {
      msgEl.className = 'error';
      msgEl.textContent = `Failed to update ${fieldType}: ${error.message}`;
      saveBtn.disabled = false;
      saveBtn.innerHTML = '✓';
    }
  }

  // Cancel field edit
  function cancelFieldEdit(fieldElement, originalValue) {
    if (Array.isArray(originalValue)) {
      // Handle tag cancellation
      const container = fieldElement.parentElement.querySelector('.inline-tag-editor');
      const saveBtn = fieldElement.parentElement.querySelector('.save-btn');
      const cancelBtn = fieldElement.parentElement.querySelector('.cancel-btn');
      
      if (container) container.remove();
      if (saveBtn) saveBtn.remove();
      if (cancelBtn) cancelBtn.remove();
      
      fieldElement.style.display = 'inline-block';
      fieldElement.parentElement.querySelector('.edit-btn').style.display = 'inline-block';
    } else {
      // Handle regular field cancellation
      fieldElement.style.display = '';
      fieldElement.textContent = originalValue;
      
      const editBtn = fieldElement.parentElement.querySelector('.edit-btn');
      editBtn.style.display = '';
      
      // Remove input and buttons
      fieldElement.parentElement.querySelectorAll('.edit-input, .edit-actions').forEach(el => el.remove());
    }
  }
</script>

</body>
</html>