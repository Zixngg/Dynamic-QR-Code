<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Edit QR • Dynamic QR Code</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/header.css">
  <style>
    .wide { width:100%; max-width: 760px; }
    .row-inline { display:flex; gap:10px; }
    .row-inline .input { flex:1; }
    .qr-line { display:flex; gap:14px; align-items:center; margin-bottom: 10px; }
    .qr-line img { width:120px; height:120px; border:1px solid var(--border); border-radius:8px; }
    /* page-specific layout overrides */
    main.container.edit-page { align-items: flex-start; }
    .stack { width:100%; max-width: 820px; margin:0 auto; display:flex; flex-direction:column; gap:16px; }
  </style>
</head>
<body>
<header class="header">
  <a class="header__brand" href="/">Dynamic QR Code</a>
  <nav class="nav">
    <a href="/dashboard.html">Dashboard</a>
    <div class="QRCode-menu">
      <button type="button" onclick="toggleQRCodeMenu()">QR Code ▾</button>
      <div class="QRCode-dropdown" id="QRCodeDropdown">
        <a href="/generateQR.html">Generate QR Codes</a>
        <a href="/qr.html">My QR Codes</a>
      </div>
    </div>
    <div class="profile-menu">
      <button type="button" onclick="toggleProfileMenu()">Profile ▾</button>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="./profile.html">View Profile</a>
        <form action="/auth/logout" method="post"><button type="submit">Logout</button></form>
      </div>
    </div>
  </nav>
</header>

<main class="container edit-page">
  <div class="stack">
  <form class="card wide" id="f" method="post" enctype="application/x-www-form-urlencoded">
    <h1>Edit QR</h1>
    <!-- ✅ single form-msg -->
    <div id="form-msg"></div>
    <p class="sub">Retarget the destination — the QR image stays the same.</p>

    <div class="qr-line">
      <img id="qrImg" alt="QR">
      <div>
        <div><strong>Name:</strong> <span id="qrName">—</span></div>
        <div><strong>Slug:</strong> <span id="qrSlug">—</span></div>
        <div><a id="qrDyn" class="link" href="#" target="_blank">Open dynamic link</a></div>
        <div><a id="dlLink" class="link" href="#" download>Download SVG</a></div>
      </div>
    </div>

    <div class="row">
      <input class="input" type="url" name="url" id="url" placeholder="New Destination URL (http/https)" required>
    </div>

    <div class="row row-inline">
      <input class="input" type="text" name="utm_source" id="utm_source" placeholder="utm_source (optional)">
      <input class="input" type="text" name="utm_medium" id="utm_medium" placeholder="utm_medium (optional)">
      <input class="input" type="text" name="utm_campaign" id="utm_campaign" placeholder="utm_campaign (optional)">
    </div>

    <button class="btn" type="submit">Save new target</button>
  </form>

  <form class="card wide" id="designForm">
    <h2>Edit Design</h2>
    <div class="row row-inline">
      <div>
        <label>Foreground</label>
        <input class="input" type="color" name="fg" id="fg" value="#0b3d91">
      </div>
      <div>
        <label>Background</label>
        <input class="input" type="color" name="bg" id="bg" value="#ffffff">
      </div>
      <div>
        <label>Error correction</label>
        <select class="input" name="ec" id="ec">
          <option value="L">L (7%)</option>
          <option value="M" selected>M (15%)</option>
          <option value="Q">Q (25%)</option>
          <option value="H">H (30%)</option>
        </select>
      </div>
      <div>
        <label>Logo size (%)</label>
        <input class="input" type="number" name="logoSizePct" id="logoSizePct" min="10" max="40" value="22">
      </div>
    </div>

    <div class="row">
      <label>Center logo (optional)</label>
      <div class="logo-row">
        <input type="file" id="logoInput" accept=".png,.jpg,.jpeg,.svg" />
        <input type="hidden" name="logoUrl" id="logoUrl">
        <img id="logoThumb" alt="logo" style="display:none; width:42px; height:42px; border-radius:6px; border:1px solid var(--border)">
      </div>
    </div>

    <div class="row">
      <div class="preview-box" style="border:1px dashed var(--border); border-radius:8px; padding:8px; display:inline-block;">
        <img id="previewImg" alt="QR preview" style="width:180px; height:180px;">
      </div>
    </div>

    <button class="btn" type="button" id="saveDesignBtn">Save design</button>
  </form>
  </div>
</main>

<script>
  // dropdown toggles
  function toggleProfileMenu(){ const dd=document.getElementById('profileDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  function toggleQRCodeMenu(){ const dd=document.getElementById('QRCodeDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  document.addEventListener('click', (e) => {
    ['profile','QRCode'].forEach(k=>{
      const menu=document.getElementById(k+'Dropdown');
      const btn=document.querySelector('.'+k+'-menu button');
      if(menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) menu.style.display='none';
    });
  });

  const params = new URLSearchParams(location.search);
  const slug = params.get('slug');
  const msgEl = document.getElementById('form-msg');
  let currentLogoDataUrl = '';

  if (!slug) {
    msgEl.className='error'; msgEl.textContent='Missing slug';
  } else {
    // preload details
    (async function(){
      const me = await fetch('/api/me', { credentials:'include' });
      if (me.status===401) { location.href='/login.html?error=Session+expired'; return; }

      const r = await fetch('/api/qr/'+encodeURIComponent(slug), { credentials:'include' });
      if (!r.ok) { msgEl.className='error'; msgEl.textContent='Not found'; return; }
      const d = await r.json();

      document.getElementById('qrName').textContent = d.Name;
      document.getElementById('qrSlug').textContent = d.Slug;
      document.getElementById('url').value = d.CurrentUrl || '';
      if (d.UTM && d.UTM.source) document.getElementById('utm_source').value = d.UTM.source;
      if (d.UTM && d.UTM.medium) document.getElementById('utm_medium').value = d.UTM.medium;
      if (d.UTM && d.UTM.campaign) document.getElementById('utm_campaign').value = d.UTM.campaign;

      const img = document.getElementById('qrImg');
      const dl = document.getElementById('dlLink');
      const dyn = document.getElementById('qrDyn');

      img.src = '/qr/'+encodeURIComponent(slug)+'.svg';
      dl.href = img.src; dl.download = slug+'.svg';
      dyn.href = '/r/'+encodeURIComponent(slug);

      // preload current design from SVG endpoint is not exposed, so keep defaults
      refreshPreview();

      // ✅ show success/error if redirected with ?success or ?error
      if (params.get('success')) {
        msgEl.className='success';
        msgEl.textContent=params.get('success');
      }
      if (params.get('error')) {
        msgEl.className='error';
        msgEl.textContent=params.get('error');
      }
    })();
  }

  // submit retarget
  document.getElementById('f').addEventListener('submit', async (e) => {
    e.preventDefault();

    msgEl.className = '';
    msgEl.textContent = '';

    const fd = new FormData(e.target);
    const urlParams = new URLSearchParams();
    for (const [key, value] of fd.entries()) {
      urlParams.append(key, value.toString());
    }

    const r = await fetch('/qr/' + encodeURIComponent(slug) + '/retarget', {
      method: 'POST',
      body: urlParams,
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      credentials: 'include'
    });

    if (r.redirected) {
      location.href = r.url;
      return;
    }

    if (r.ok) {
      msgEl.className = 'success';
      msgEl.textContent = 'Target updated successfully';
    } else {
      msgEl.className = 'error';
      msgEl.textContent = 'Failed to update target';
    }
  });

  // ------- Design editor logic -------
  function refreshPreview(){
    const fg = document.getElementById('fg').value;
    const bg = document.getElementById('bg').value;
    const ec = document.getElementById('ec').value;
    const logoUrl = document.getElementById('logoUrl').value || '';
    const logoSizePct = document.getElementById('logoSizePct').value || '22';
    const qs = new URLSearchParams({ fg, bg, ec, logoUrl, logoSizePct });
    document.getElementById('previewImg').src = '/qr/preview?' + qs.toString();
  }
  ['fg','bg','ec','logoSizePct'].forEach(id => document.getElementById(id).addEventListener('change', refreshPreview));

  // upload logo and show thumb
  document.getElementById('logoInput').addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const fd = new FormData();
    fd.set('file', f);
    const res = await fetch('/uploads', { method:'POST', body: fd, credentials:'include' });
    if (!res.ok) { alert('Upload failed'); return; }
    const data = await res.json();
    console.log('Upload response:', data);
    document.getElementById('logoUrl').value = data.dataUrl || data.url;
    currentLogoDataUrl = data.dataUrl || data.url || '';
    console.log('Set logoUrl to:', document.getElementById('logoUrl').value ? 'data:...' : 'empty');
    const t = document.getElementById('logoThumb');
    t.src = data.url; t.style.display='inline-block';
    refreshPreview();
  });

  // save design
  document.getElementById('saveDesignBtn').addEventListener('click', async () => {
    if (!slug) return;
    const hiddenLogo = document.getElementById('logoUrl').value;
    const logoUrlValue = currentLogoDataUrl || hiddenLogo;
    console.log('Saving design with logoUrl:', logoUrlValue ? 'data:...' : 'empty');
    console.log('Full logoUrl length:', logoUrlValue ? logoUrlValue.length : 0);
    const body = new URLSearchParams({
      fg: document.getElementById('fg').value,
      bg: document.getElementById('bg').value,
      ec: document.getElementById('ec').value,
      format: 'svg',
      // encode to avoid '+' turning into spaces in form encoding
      logoUrl: encodeURIComponent(logoUrlValue),
      logoSizePct: document.getElementById('logoSizePct').value
    });
    const r = await fetch('/qr/' + encodeURIComponent(slug) + '/design', {
      method:'POST', body, headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, credentials:'include'
    });
    if (r.redirected) { location.href = r.url; return; }
    if (r.ok) { msgEl.className='success'; msgEl.textContent='Design updated'; }
    else { msgEl.className='error'; msgEl.textContent='Failed to update design'; }
  });
</script>
</body>
</html>