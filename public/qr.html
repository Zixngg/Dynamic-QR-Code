<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>My QR Codes ‚Ä¢ Dynamic QR Code</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/header.css">
  <link rel="stylesheet" href="css/qr.css">
</head>
<body>
<header class="header">
  <a class="header__brand" href="/dashboard.html">Dynamic QR Code</a>
  <nav class="nav">
    <a href="/dashboard.html">Dashboard</a>
    <div class="QRCode-menu">
      <button type="button" onclick="toggleQRCodeMenu()">QR Code ‚ñæ</button>
      <div class="QRCode-dropdown" id="QRCodeDropdown">
        <a href="/generateQR.html">Generate QR Codes</a>
        <a href="/qr.html">My QR Codes</a>
      </div>
    </div>
    <div class="profile-menu">
      <button type="button" onclick="toggleProfileMenu()">Profile ‚ñæ</button>
      <div class="profile-dropdown" id="profileDropdown">
        <a href="./profile.html">View Profile</a>
        <form action="/auth/logout" method="post">
          <button type="submit">Logout</button>
        </form>
      </div>
    </div>
  </nav>
</header>

<main class="list">
  <div class="list-header">
    <div class="header-content">
  <h1>My QR Codes</h1>
      <p class="sub">Click a link to open its dynamic redirect URL, or edit to change the destination.</p>
    </div>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search QR codes by name..." class="search-input">
      <div class="search-icon">üîç</div>
    </div>
    <div class="filter-container">
      <div class="multi-select-wrapper">
        <div class="multi-select-header" id="tagFilterHeader">
          <span id="tagFilterText">All Tags</span>
          <span class="dropdown-arrow">‚ñº</span>
        </div>
        <div class="multi-select-options" id="tagFilterOptions" style="display: none;">
          <div class="option-item">
            <input type="checkbox" id="allTags" checked>
            <label for="allTags">All Tags</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="form-msg"></div>

  <div class="qr-grid" id="qrGrid">
    <!-- QR cards will be inserted here -->
  </div>

  <!-- Pagination -->
  <div class="pagination" id="pagination" style="display: none;">
    <button id="prevBtn" class="pagination-btn" disabled>‚Äπ</button>
    <div class="pagination-pages" id="paginationPages">
      <!-- Page numbers will be inserted here -->
    </div>
    <button id="nextBtn" class="pagination-btn" disabled>‚Ä∫</button>
  </div>

  <table id="tbl" style="display: none;">
    <thead>
      <tr>
        <th>Preview</th>
        <th>Name</th>
        <th>Slug</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script>
  // dropdown toggles
  function toggleProfileMenu(){ const dd=document.getElementById('profileDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  function toggleQRCodeMenu(){ const dd=document.getElementById('QRCodeDropdown'); dd.style.display=dd.style.display==='block'?'none':'block'; }
  document.addEventListener('click', (e) => {
    ['profile','QRCode'].forEach(k=>{
      const menu=document.getElementById(k+'Dropdown');
      const btn=document.querySelector('.'+k+'-menu button');
      if(menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) menu.style.display='none';
    });
  });

  // handle messages from redirects (?success= / ?error=)
  const params = new URLSearchParams(location.search);
  const msgEl = document.getElementById('form-msg');
  if (params.get('error')) {
    msgEl.className='error';
    msgEl.textContent=params.get('error');
  }
  if (params.get('success')) {
    msgEl.className='success';
    msgEl.textContent=params.get('success');
  }

  // Global variables
  let allQRCodes = [];
  let currentPage = 1;
  const itemsPerPage = 6;
  let filteredQRCodes = [];
  let selectedTags = new Set(); // Track selected tags

  // Pagination functionality
  function updatePagination() {
    const totalPages = Math.ceil(filteredQRCodes.length / itemsPerPage);
    const pagination = document.getElementById('pagination');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const paginationPages = document.getElementById('paginationPages');

    if (totalPages <= 1) {
      pagination.style.display = 'none';
      return;
    }

    pagination.style.display = 'flex';
    
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    
    // Generate page numbers
    generatePageNumbers(totalPages, paginationPages);
  }

  function generatePageNumbers(totalPages, container) {
    container.innerHTML = '';
    
    if (totalPages <= 7) {
      // Show all pages if 7 or fewer
      for (let i = 1; i <= totalPages; i++) {
        createPageButton(i, container);
      }
    } else {
      // Show smart pagination with ellipsis
      if (currentPage <= 4) {
        // Show first 5 pages + ellipsis + last page
        for (let i = 1; i <= 5; i++) {
          createPageButton(i, container);
        }
        createEllipsis(container);
        createPageButton(totalPages, container);
      } else if (currentPage >= totalPages - 3) {
        // Show first page + ellipsis + last 5 pages
        createPageButton(1, container);
        createEllipsis(container);
        for (let i = totalPages - 4; i <= totalPages; i++) {
          createPageButton(i, container);
        }
      } else {
        // Show first page + ellipsis + current-1, current, current+1 + ellipsis + last page
        createPageButton(1, container);
        createEllipsis(container);
        for (let i = currentPage - 1; i <= currentPage + 1; i++) {
          createPageButton(i, container);
        }
        createEllipsis(container);
        createPageButton(totalPages, container);
      }
    }
  }

  function createPageButton(pageNum, container) {
    const button = document.createElement('button');
    button.className = `pagination-btn page-btn ${pageNum === currentPage ? 'active' : ''}`;
    button.textContent = pageNum;
    button.onclick = () => {
      currentPage = pageNum;
      renderCurrentPage();
    };
    container.appendChild(button);
  }

  function createEllipsis(container) {
    const ellipsis = document.createElement('span');
    ellipsis.className = 'pagination-ellipsis';
    ellipsis.textContent = '...';
    container.appendChild(ellipsis);
  }

  function renderCurrentPage() {
    const qrGrid = document.getElementById('qrGrid');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageQRCodes = filteredQRCodes.slice(startIndex, endIndex);

    qrGrid.innerHTML = '';

    if (pageQRCodes.length === 0) {
      qrGrid.innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üîç</div>
          <h3>No QR codes found</h3>
          <p>Try adjusting your search terms or <a href="/generateQR.html">create a new QR code</a></p>
        </div>
      `;
      return;
    }

    pageQRCodes.forEach(createQRCard);
    updatePagination();
  }

  // Search functionality
  function filterQRCodes(searchTerm, selectedTagsSet) {
    filteredQRCodes = allQRCodes.filter(qr => 
      qr.Name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    // Apply tag filter
    if (selectedTagsSet && selectedTagsSet.size > 0) {
      filteredQRCodes = filteredQRCodes.filter(qr => {
        if (!qr.Tags) return false;
        const tags = typeof qr.Tags === 'string' ? JSON.parse(qr.Tags) : qr.Tags;
        if (!Array.isArray(tags)) return false;
        
        // Check if QR code has any of the selected tags
        return tags.some(tag => selectedTagsSet.has(tag.name));
      });
    }
    
    // Reset to first page when filtering
    currentPage = 1;
    renderCurrentPage();
  }

  // Create QR card element
  function createQRCard(qr) {
    const card = document.createElement('div');
    card.className = 'qr-card';
    card.innerHTML = `
      <div class="qr-preview">
        <img src="/qr/${encodeURIComponent(qr.Slug)}/svg" alt="QR Code">
      </div>
      <div class="qr-info">
        <div class="qr-info-left">
          <h3 class="qr-name">${qr.Name}</h3>
          <p class="qr-slug">${qr.Slug}</p>
          <p class="qr-date">Created ${new Date(qr.CreatedAt).toLocaleDateString()}</p>
          <p class="qr-scans">üìä ${qr.ScanCount || 0} scans</p>
        </div>
        <div class="qr-tags">
          ${(() => {
            console.log('Processing tags for QR:', qr.Name, 'Raw tags:', qr.Tags);
            const tags = qr.Tags ? (typeof qr.Tags === 'string' ? JSON.parse(qr.Tags) : qr.Tags) : [];
            console.log('Parsed tags:', tags);
            return tags && tags.length > 0 ? 
              tags.map(tag => `<span class="tag" style="background-color: ${tag.color}; color: white;">${tag.name}</span>`).join('') :
              '<span class="no-tags">No tags</span>';
          })()}
        </div>
      </div>
      <div class="qr-actions">
        <a href="/r/${encodeURIComponent(qr.Slug)}" target="_blank" class="action-btn primary">
          <span>üîó</span> Open
        </a>
        <a href="/editQR.html?slug=${encodeURIComponent(qr.Slug)}" class="action-btn secondary">
          <span>‚úèÔ∏è</span> Edit
        </a>
        <form method="post" action="/qr/${encodeURIComponent(qr.Slug)}/delete" onsubmit="return confirm('Delete this QR code?');" class="delete-form">
          <button type="submit" class="action-btn danger">
            <span>üóëÔ∏è</span> Delete
          </button>
        </form>
      </div>
    `;
    document.getElementById('qrGrid').appendChild(card);
  }

  // Multi-select functionality
  function toggleTagFilter() {
    const options = document.getElementById('tagFilterOptions');
    const arrow = document.querySelector('.dropdown-arrow');
    
    if (options.style.display === 'none') {
      options.style.display = 'block';
      arrow.textContent = '‚ñ≤';
    } else {
      options.style.display = 'none';
      arrow.textContent = '‚ñº';
    }
  }

  function updateTagFilterText() {
    const text = document.getElementById('tagFilterText');
    if (selectedTags.size === 0) {
      text.textContent = 'All Tags';
    } else if (selectedTags.size === 1) {
      text.textContent = Array.from(selectedTags)[0];
    } else {
      text.textContent = `${selectedTags.size} tags selected`;
    }
  }

  function handleTagSelection(tagName, isChecked) {
    if (tagName === 'allTags') {
      if (isChecked) {
        selectedTags.clear();
        // Uncheck all other checkboxes
        document.querySelectorAll('.option-item input[type="checkbox"]:not(#allTags)').forEach(cb => {
          cb.checked = false;
        });
      }
    } else {
      if (isChecked) {
        selectedTags.add(tagName);
        // Uncheck "All Tags" if a specific tag is selected
        document.getElementById('allTags').checked = false;
      } else {
        selectedTags.delete(tagName);
        // Check "All Tags" if no specific tags are selected
        if (selectedTags.size === 0) {
          document.getElementById('allTags').checked = true;
        }
      }
    }
    
    updateTagFilterText();
    filterQRCodes(document.getElementById('searchInput').value, selectedTags);
  }

  // Search input event listener
  document.getElementById('searchInput').addEventListener('input', (e) => {
    filterQRCodes(e.target.value, selectedTags);
  });
  
  // Multi-select event listeners
  document.getElementById('tagFilterHeader').addEventListener('click', toggleTagFilter);
  
  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const wrapper = document.querySelector('.multi-select-wrapper');
    if (!wrapper.contains(e.target)) {
      document.getElementById('tagFilterOptions').style.display = 'none';
      document.querySelector('.dropdown-arrow').textContent = '‚ñº';
    }
  });

  // Pagination button event listeners
  document.getElementById('prevBtn').addEventListener('click', () => {
    if (currentPage > 1) {
      currentPage--;
      renderCurrentPage();
    }
  });

  document.getElementById('nextBtn').addEventListener('click', () => {
    const totalPages = Math.ceil(filteredQRCodes.length / itemsPerPage);
    if (currentPage < totalPages) {
      currentPage++;
      renderCurrentPage();
    }
  });

  // fetch and render QR codes
  (async function(){
    console.log('Starting QR list fetch...');
    
    const me = await fetch('/api/me', { credentials:'include' });
    console.log('Me response:', me.status);
    if (me.status===401) {
      location.href='/login.html?error=Session+expired';
      return;
    }

    console.log('Fetching QR codes...');
    const r = await fetch('/api/my/qr', { credentials:'include' });
    console.log('QR response:', r.status, r.statusText);
    
    if (!r.ok) {
      console.error('QR fetch failed:', r.status, r.statusText);
      return;
    }
    
    const rows = await r.json();
    console.log('QR codes received:', rows);
    
    // Fetch scan counts
    console.log('Fetching scan counts...');
    const scanResponse = await fetch('/api/my/qr/scans', { credentials:'include' });
    let scanCounts = {};
    if (scanResponse.ok) {
      scanCounts = await scanResponse.json();
      console.log('Scan counts received:', scanCounts);
    } else {
      console.warn('Failed to fetch scan counts:', scanResponse.status);
    }
    
    // Merge scan counts with QR data
    const rowsWithScans = rows.map(qr => ({
      ...qr,
      ScanCount: scanCounts[qr.Slug] || 0
    }));
    
    allQRCodes = rowsWithScans;

    if (rows.length === 0) {
      document.getElementById('qrGrid').innerHTML = `
        <div class="no-results">
          <div class="no-results-icon">üì±</div>
          <h3>No QR codes yet</h3>
          <p>Create your first QR code to get started</p>
          <a href="/generateQR.html" class="create-btn">Create QR Code</a>
        </div>
      `;
      return;
    }

    // Populate tag filter
    const tagFilterOptions = document.getElementById('tagFilterOptions');
    const allTags = new Set();
    console.log('Processing QR codes for tag filter:', rows);
    rows.forEach(qr => {
      console.log('QR:', qr.Name, 'Tags:', qr.Tags);
      if (qr.Tags) {
        const tags = typeof qr.Tags === 'string' ? JSON.parse(qr.Tags) : qr.Tags;
        console.log('Parsed tags for filter:', tags);
        if (Array.isArray(tags)) {
          tags.forEach(tag => allTags.add(tag.name));
        }
      }
    });
    console.log('All unique tags found:', Array.from(allTags));
    
    // Clear existing options except "All Tags"
    tagFilterOptions.innerHTML = `
      <div class="option-item">
        <input type="checkbox" id="allTags" checked onchange="handleTagSelection('allTags', this.checked)">
        <label for="allTags">All Tags</label>
      </div>
    `;
    
    // Add tag options
    Array.from(allTags).sort().forEach(tagName => {
      const optionItem = document.createElement('div');
      optionItem.className = 'option-item';
      optionItem.innerHTML = `
        <input type="checkbox" id="tag_${tagName.replace(/\s+/g, '_')}" onchange="handleTagSelection('${tagName}', this.checked)">
        <label for="tag_${tagName.replace(/\s+/g, '_')}">${tagName}</label>
      `;
      tagFilterOptions.appendChild(optionItem);
    });

    // Initialize filtered list and render first page
    filteredQRCodes = [...allQRCodes];
    currentPage = 1;
    renderCurrentPage();
  })();
</script>
</body>
</html>
